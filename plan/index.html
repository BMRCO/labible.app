<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan (365 jours) | LaBible.app â€” LSG 1910</title>
  <meta name="description" content="Lire toute la Bible en 1 an â€” Plan de lecture (365 jours) Louis Segond 1910. Ouverture automatique du jour, suivi et recherche." />
  <link rel="canonical" href="https://labible.app/plan/" />
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <link rel="stylesheet" href="/style.css?v=3" />

  <style>
    .planTop{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .planActions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
    body:not(.dark) .pill{background:rgba(11,18,32,.03)}
    .input{width:160px;max-width:60vw;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.05);color:inherit;outline:none}
    body:not(.dark) .input{background:rgba(11,18,32,.03)}
    .progressbar{height:12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);overflow:hidden}
    .progressbar>div{height:100%;width:0%;background:linear-gradient(135deg,var(--primary),var(--primary2))}
    .days{display:grid;gap:10px}
    details.day{border:1px solid var(--line);border-radius:18px;background:rgba(255,255,255,.03);overflow:hidden}
    body:not(.dark) details.day{background:rgba(11,18,32,.02)}
    summary.daySum{list-style:none;cursor:pointer;padding:12px 12px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    summary.daySum::-webkit-details-marker{display:none}
    .dLeft{display:flex;gap:12px;align-items:center;min-width:0}
    .badge{font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04)}
    body:not(.dark) .badge{background:rgba(11,18,32,.03)}
    .dMain{min-width:0}
    .dRef{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dMeta{color:var(--muted);font-size:13px;margin-top:2px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .dBody{padding:0 12px 12px;border-top:1px solid var(--line)}
    .segments{display:grid;gap:10px;padding-top:12px}
    .seg{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;border:1px solid var(--line);border-radius:16px;padding:10px 12px;background:rgba(255,255,255,.03)}
    body:not(.dark) .seg{background:rgba(11,18,32,.02)}
    .seg .t{font-weight:900}
    .seg .s{color:var(--muted);font-size:13px;margin-top:2px}
    .today{outline:2px solid rgba(90,162,255,.75)}
    .smallnote{color:var(--muted);font-size:13px;margin:0}
    .mini{padding:8px 10px;border-radius:14px}
    .doneTag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-weight:900;font-size:12px;background:rgba(255,255,255,.04)}
    body:not(.dark) .doneTag{background:rgba(11,18,32,.03)}
  </style>
</head>

<body>
  <header class="topbar">
    <a class="brand" href="/" aria-label="Accueil LaBible.app">
      <span class="brand-icon">ðŸ“–</span>
      <span class="brand-text">
        <span class="brand-title">LaBible.app</span>
        <span class="brand-subtitle">LSG 1910</span>
      </span>
    </a>
    <div class="top-actions">
      <button id="toggleTheme" class="iconbtn" type="button" aria-label="Mode sombre">ðŸŒ™</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="planTop">
        <div>
          <h1 class="chapterTitle" style="margin:0">Plan de lecture â€” 365 jours</h1>
          <p style="margin:10px 0 0" class="smallnote">Lire toute la Bible en 1 an â€” Louis Segond 1910 (LSG).</p>
        </div>

        <div class="planActions">
          <span class="pill">ðŸ“… DÃ©but : <b id="startLabel">â€”</b></span>
          <span class="pill">âœ… Jour : <b id="todayNum">â€”</b></span>

          <button id="btnContinue" class="btn primary" type="button">Continuer</button>
          <button id="btnOpenToday" class="btn primary" type="button">Ouvrir le jour actuel</button>
          <button id="btnReset" class="btn" type="button">RÃ©initialiser</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="progressbar" aria-label="Progression"><div id="bar"></div></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px">
          <p class="smallnote" id="progressText">â€”</p>

          <span class="pill">
            Aller au jour
            <input id="dayJump" class="input" type="number" min="1" max="365" placeholder="ex: 120">
            <button id="btnGo" class="btn mini" type="button">Aller</button>
          </span>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-top:10px">
          <span class="pill" style="flex:1;justify-content:space-between;gap:12px;">
            <span style="white-space:nowrap;">ðŸ”Ž Rechercher</span>
            <input id="planSearch" class="input" type="search" placeholder="ex: GenÃ¨se / Matthieu / jour 120" style="flex:1;width:auto;">
            <button id="btnClearSearch" class="btn mini" type="button">Effacer</button>
          </span>
        </div>
      </div>
    </section>

    <section class="card">
      <p class="smallnote">
        Clique sur un jour pour voir ses chapitres. Tu peux marquer un jour comme <b>fait</b> âœ….
      </p>
    </section>

    <section id="days" class="days" aria-live="polite"></section>
  </main>

  <footer class="footer">
    <nav class="footlinks">
      <a href="/">Accueil</a>
      <a href="/a-propos/">Ã€ propos</a>
      <a href="/plan/">Plan (365 jours)</a>
      <a href="/confidentialite/">ConfidentialitÃ©</a>
    </nav>
    <div class="footnote">
      Â© <span id="year"></span> LaBible.app â€” Louis Segond 1910 (LSG)
    </div>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // Theme
    (function(){
      const btn = document.getElementById("toggleTheme");
      if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark");
      if(btn){
        const sync = ()=> btn.textContent = document.body.classList.contains("dark") ? "â˜€ï¸" : "ðŸŒ™";
        sync();
        btn.addEventListener("click", ()=>{
          document.body.classList.toggle("dark");
          localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
          sync();
        });
      }
    })();

    // Helpers
    const escapeHTML = (s)=> String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    const normalize = (s)=> String(s).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const slugifyBookName = (name)=> normalize(name).replace(/['â€™]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"");

    async function loadJSON(path){
      const r = await fetch(path, { cache: "no-store" });
      if(!r.ok) throw new Error("Erreur de chargement : " + path);
      return r.json();
    }

    function fmtDate(d){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
      return `${day}/${m}/${y}`;
    }

    // LocalStorage keys
    const LS = {
      startKey: "labible_plan_start_v1",
      doneKey:  "labible_plan_done_v1",
      lastKey:  "labible_plan_last_day_v1"
    };

    function getStartDate(){
      const raw = localStorage.getItem(LS.startKey);
      if(!raw) return null;
      const d = new Date(raw);
      return isNaN(d.getTime()) ? null : d;
    }
    function setStartDate(d){ localStorage.setItem(LS.startKey, d.toISOString()); }
    function clearStartDate(){ localStorage.removeItem(LS.startKey); }

    function ensureStartDate(){
      let d = getStartDate();
      if(!d){
        const now = new Date();
        d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        setStartDate(d);
      }
      return d;
    }

    function dayIndexToday(){
      const start = ensureStartDate();
      const now = new Date();
      const a = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      const b = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const diff = Math.floor((b - a) / (1000*60*60*24));
      const idx = diff + 1;
      if(idx < 1) return 1;
      if(idx > 365) return 365;
      return idx;
    }

    function getDoneSet(){
      try{
        const arr = JSON.parse(localStorage.getItem(LS.doneKey) || "[]");
        return new Set(arr);
      }catch{
        return new Set();
      }
    }
    function saveDoneSet(set){
      localStorage.setItem(LS.doneKey, JSON.stringify(Array.from(set)));
    }

    function setLastDay(n){ localStorage.setItem(LS.lastKey, String(n)); }
    function getLastDay(){
      const v = parseInt(localStorage.getItem(LS.lastKey) || "", 10);
      return Number.isFinite(v) ? v : null;
    }

    // Build books/chapters from DB
    function buildBooksFromDB(DB){
      const mapBookName = new Map();
      const mapBookChaps = new Map();
      for(const v of DB.verses){
        if(!mapBookName.has(v.book)) mapBookName.set(v.book, v.book_name);
        if(!mapBookChaps.has(v.book)) mapBookChaps.set(v.book, new Set());
        mapBookChaps.get(v.book).add(v.chapter);
      }
      return Array.from(mapBookName.entries())
        .map(([book,name])=>{
          const chaps = Array.from(mapBookChaps.get(book)||[]).sort((a,b)=>a-b);
          return { book, name, slug: slugifyBookName(name), chapters: chaps };
        })
        .sort((a,b)=>a.book-b.book);
    }

    function buildAllChapters(BOOKS){
      const out = [];
      for(const b of BOOKS){
        for(const c of b.chapters){
          out.push({ book:b.book, slug:b.slug, name:b.name, chapter:c });
        }
      }
      return out;
    }

    function splitIntoDays(all){
      const total = all.length;
      const days = 365;
      const base = Math.floor(total / days);
      const rem = total % days;
      const chunks = [];
      let i=0;
      for(let d=1; d<=days; d++){
        const size = base + (d <= rem ? 1 : 0);
        chunks.push(all.slice(i, i+size));
        i += size;
      }
      return chunks;
    }

    function summarizeDay(chunks){
      const segs = [];
      let cur = null;
      for(const x of chunks){
        if(!cur){
          cur = { name:x.name, slug:x.slug, start:x.chapter, end:x.chapter };
          continue;
        }
        if(x.slug === cur.slug && x.chapter === cur.end + 1){
          cur.end = x.chapter;
        }else{
          segs.push(cur);
          cur = { name:x.name, slug:x.slug, start:x.chapter, end:x.chapter };
        }
      }
      if(cur) segs.push(cur);

      const pretty = segs.map(s=>{
        const range = s.start === s.end ? `${s.start}` : `${s.start}â€“${s.end}`;
        return `${s.name} ${range}`;
      });

      return { segs, prettyText: pretty.join(" â€¢ ") };
    }

    function buildSegLink(seg){
      return `/${seg.slug}/${seg.start}`;
    }

    let DAYS = [];
    let DONE = new Set();

    function setProgressUI(){
      const start = ensureStartDate();
      document.getElementById("startLabel").textContent = fmtDate(start);

      const idx = dayIndexToday();
      document.getElementById("todayNum").textContent = idx;

      const pct = Math.round((idx/365)*100);
      document.getElementById("bar").style.width = pct + "%";

      const doneCount = DONE.size;
      document.getElementById("progressText").textContent =
        `Progression : jour ${idx} / 365 (${pct}%) â€” ${doneCount} jour(s) fait(s)`;
    }

    function renderDays(){
      const wrap = document.getElementById("days");
      const idxToday = dayIndexToday();

      const q = normalize(document.getElementById("planSearch").value.trim());

      const rows = DAYS.map((dayChaps, i)=>{
        const dayNo = i + 1;
        const info = summarizeDay(dayChaps);
        const done = DONE.has(dayNo);
        const isToday = idxToday === dayNo;

        // Search filter
        if(q){
          const hay = normalize(`jour ${dayNo} ${info.prettyText}`);
          if(!hay.includes(q)) return "";
        }

        const segHtml = info.segs.map(seg=>{
          const range = seg.start === seg.end ? `${seg.start}` : `${seg.start}â€“${seg.end}`;
          return `
            <div class="seg">
              <div>
                <div class="t">${escapeHTML(seg.name)} ${escapeHTML(range)}</div>
                <div class="s">Ouvre directement la lecture</div>
              </div>
              <a class="btn primary" style="text-decoration:none;display:inline-block" href="${buildSegLink(seg)}">Ouvrir</a>
            </div>
          `;
        }).join("");

        return `
          <details class="day ${(isToday ? "today" : "")}" id="day-${dayNo}">
            <summary class="daySum">
              <div class="dLeft">
                <span class="badge">Jour ${dayNo}</span>
                <div class="dMain">
                  <div class="dRef">${escapeHTML(info.prettyText)}</div>
                  <div class="dMeta">
                    <span>${dayChaps.length} chapitre(s)</span>
                    ${done ? `<span class="doneTag">âœ… Fait</span>` : ``}
                  </div>
                </div>
              </div>
              <span style="opacity:.75">âŒ„</span>
            </summary>
            <div class="dBody">
              <div class="segments">
                ${segHtml}
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                <button class="btn ${done ? "" : "primary"}" type="button" data-toggle-done="${dayNo}">
                  ${done ? "Annuler (pas fait)" : "Marquer comme fait âœ…"}
                </button>
              </div>
            </div>
          </details>
        `;
      }).filter(Boolean).join("");

      wrap.innerHTML = rows || `<div class="card"><p class="smallnote">Aucun rÃ©sultat.</p></div>`;

      // bind done buttons
      wrap.querySelectorAll("[data-toggle-done]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const n = Number(btn.getAttribute("data-toggle-done"));
          if(DONE.has(n)) DONE.delete(n); else DONE.add(n);
          saveDoneSet(DONE);
          setProgressUI();
          renderDays();
          // keep the same day open
          const el = document.getElementById("day-" + n);
          if(el){ el.open = true; el.scrollIntoView({behavior:"smooth", block:"start"}); }
        });
      });

      // open today if no search, else don't force
      if(!q){
        const el = document.getElementById("day-" + idxToday);
        if(el){
          el.open = true;
          el.scrollIntoView({ behavior:"smooth", block:"start" });
        }
      }
    }

    function goToDay(n){
      const day = Math.max(1, Math.min(365, Number(n)||1));
      const el = document.getElementById("day-" + day);
      if(el){
        el.open = true;
        el.scrollIntoView({ behavior:"smooth", block:"start" });
      }
    }

    function openDay(n){
      const day = DAYS[n-1];
      if(!day || !day.length) return;
      const first = day[0];
      setLastDay(n);
      location.href = `/${first.slug}/${first.chapter}`;
    }

    function openToday(){
      openDay(dayIndexToday());
    }

    function openContinue(){
      const last = getLastDay();
      if(last && last >= 1 && last <= 365){
        openDay(last);
      }else{
        openToday();
      }
    }

    async function init(){
      DONE = getDoneSet();

      // âœ… caminho relativo (estamos em /plan/)
      const DB = await loadJSON("../data/segond_1910.json?v=4");

      const BOOKS = buildBooksFromDB(DB);
      const ALL = buildAllChapters(BOOKS);
      DAYS = splitIntoDays(ALL);

      setProgressUI();
      renderDays();

      document.getElementById("btnOpenToday").addEventListener("click", openToday);
      document.getElementById("btnContinue").addEventListener("click", openContinue);

      document.getElementById("btnReset").addEventListener("click", ()=>{
        // reset plan start + done + last
        localStorage.removeItem(LS.doneKey);
        localStorage.removeItem(LS.lastKey);
        clearStartDate();
        ensureStartDate();
        DONE = new Set();
        setProgressUI();
        renderDays();
      });

      document.getElementById("btnGo").addEventListener("click", ()=>{
        const v = document.getElementById("dayJump").value;
        goToDay(v);
      });

      const search = document.getElementById("planSearch");
      search.addEventListener("input", ()=>{
        renderDays();
      });

      document.getElementById("btnClearSearch").addEventListener("click", ()=>{
        search.value = "";
        renderDays();
      });
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      init().catch(err=>{
        console.error(err);
        document.body.innerHTML = `<pre style="color:red;padding:16px;">${escapeHTML(err.message)}</pre>`;
      });
    });
  </script>

</body>
</html>