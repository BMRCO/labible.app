<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Plan (365 jours) | LaBible.app â€” LSG 1910</title>
  <meta name="description" content="Plan de lecture de la Bible sur 365 jours â€” LaBible.app (LSG 1910). Ouvrir le jour actuel, continuer et marquer les jours comme faits." />
  <link rel="canonical" href="https://labible.app/plan/" />

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">

  <link rel="stylesheet" href="/style.css?v=4" />
</head>

<body>
  <!-- TOPBAR (sem links, sÃ³ logo + tema) -->
  <header class="topbar">
    <a class="brand" href="/" aria-label="Accueil LaBible.app">
      <span class="brand-icon">ðŸ“–</span>
      <span class="brand-text">
        <span class="brand-title">LaBible.app</span>
        <span class="brand-subtitle">LSG 1910</span>
      </span>
    </a>

    <div class="top-actions">
      <button id="toggleTheme" class="iconbtn" type="button" aria-label="Mode sombre">ðŸŒ™</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h1 class="chapterTitle">Plan de lecture â€” 365 jours</h1>

      <div class="row" style="gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="btnToday" class="btn primary" type="button">ðŸ“… Ouvrir le jour actuel</button>
        <button id="btnContinue" class="btn" type="button">â–¶ Continuer</button>
        <button id="btnToggleDoneToday" class="btn" type="button">âœ… Marquer aujourdâ€™hui comme fait</button>
      </div>

      <div class="row searchrow" style="margin-top:12px;">
        <div class="field grow">
          <label for="qplan">Rechercher dans le plan</label>
          <input id="qplan" type="search" placeholder="Ex : GenÃ¨se, Psaumes, Jean, Romainsâ€¦" />
        </div>
        <button id="btnClear" class="btn" type="button">Effacer</button>
      </div>

      <div id="planInfo" class="small" style="opacity:.9; margin-top:10px;"></div>

      <hr style="border:0;border-top:1px solid var(--line);margin:14px 0">

      <div id="planList"></div>
    </section>
  </main>

  <!-- FOOTER (links sÃ³ aqui) -->
  <footer class="footer">
    <nav class="footlinks">
      <a href="/" aria-label="Accueil">Accueil</a>
      <a href="/a-propos/" aria-label="Ã€ propos">Ã€ propos</a>
      <a href="/plan/" aria-label="Plan de lecture">Plan (365 jours)</a>
      <a href="/confidentialite/" aria-label="ConfidentialitÃ©">ConfidentialitÃ©</a>
    </nav>
    <div class="footnote">
      Â© <span id="year"></span> LaBible.app â€” Louis Segond 1910 (LSG)
    </div>
  </footer>

  <script>
  // ---------------- Helpers UI + Theme ----------------
  const $ = (id) => document.getElementById(id);

  function applyThemeFromStorage(){
    const saved = localStorage.getItem("theme");
    if (saved === "dark") document.body.classList.add("dark");
  }
  function setupThemeToggle(){
    const btn = $("toggleTheme");
    if (!btn) return;
    const sync = () => btn.textContent = document.body.classList.contains("dark") ? "â˜€ï¸" : "ðŸŒ™";
    sync();
    btn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
      sync();
    });
  }

  async function loadJSON(path) {
    const r = await fetch(path, { cache: "no-store" });
    if (!r.ok) throw new Error("Erreur de chargement : " + path);
    return r.json();
  }

  function escapeHTML(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function normalize(s){
    return String(s).toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  }

  function slugifyBookName(name) {
    return normalize(name)
      .replace(/['â€™]/g, "")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "");
  }

  function dayOfYearLocal(d = new Date()) {
    // local time
    const start = new Date(d.getFullYear(), 0, 1);
    const diff = d - start;
    const oneDay = 24 * 60 * 60 * 1000;
    return Math.floor(diff / oneDay) + 1; // 1..365/366
  }

  // ---------------- Storage ----------------
  const KEY_DONE = "plan_done_days_v1";     // array of day numbers
  const KEY_LAST = "plan_last_day_v1";      // last opened day number

  function getDoneSet(){
    try {
      const arr = JSON.parse(localStorage.getItem(KEY_DONE)) || [];
      return new Set(arr.map(n => Number(n)).filter(n => Number.isFinite(n)));
    } catch {
      return new Set();
    }
  }
  function saveDoneSet(set){
    localStorage.setItem(KEY_DONE, JSON.stringify(Array.from(set).sort((a,b)=>a-b)));
  }
  function getLastDay(){
    const n = Number(localStorage.getItem(KEY_LAST));
    return Number.isFinite(n) && n >= 1 && n <= 365 ? n : null;
  }
  function setLastDay(n){
    localStorage.setItem(KEY_LAST, String(n));
  }

  // ---------------- Plan generation (365 jours, chapitres 1x) ----------------
  // DB schema expected: DB.verses = [{book, book_name, chapter, verse, text}, ...]
  function buildCanonicalChapters(DB){
    const mapBookName = new Map(); // bookNum -> name
    const chaptersByBook = new Map(); // bookNum -> Set(chapters)

    for (const v of DB.verses) {
      if (!mapBookName.has(v.book)) mapBookName.set(v.book, v.book_name);
      if (!chaptersByBook.has(v.book)) chaptersByBook.set(v.book, new Set());
      chaptersByBook.get(v.book).add(v.chapter);
    }

    const books = Array.from(mapBookName.entries())
      .map(([book, name]) => ({ book, name, slug: slugifyBookName(name) }))
      .sort((a,b) => a.book - b.book);

    const chapters = [];
    for (const b of books) {
      const chaps = Array.from(chaptersByBook.get(b.book) || []).sort((a,b)=>a-b);
      for (const c of chaps) {
        chapters.push({
          book: b.book,
          bookName: b.name,
          bookSlug: b.slug,
          chapter: c,
          url: `/${b.slug}/${c}`
        });
      }
    }

    return { books, chapters };
  }

  function splitInto365Days(chapters){
    const total = chapters.length; // usually 1189
    const days = 365;

    // base size per day, distribute remainder
    const base = Math.floor(total / days);
    let extra = total % days;

    const plan = [];
    let idx = 0;

    for (let day = 1; day <= days; day++) {
      const size = base + (extra > 0 ? 1 : 0);
      if (extra > 0) extra--;

      const items = chapters.slice(idx, idx + size);
      idx += size;

      plan.push({ day, items });
    }

    // if any leftover (shouldn't), append to last day
    if (idx < chapters.length) {
      plan[plan.length - 1].items.push(...chapters.slice(idx));
    }

    return plan;
  }

  function formatRefs(items){
    // Group by book name and ranges of consecutive chapters: "GenÃ¨se 1â€“3, 5; Exode 1â€“2"
    const byBook = new Map();
    for (const it of items) {
      if (!byBook.has(it.book)) byBook.set(it.book, { bookName: it.bookName, bookSlug: it.bookSlug, chapters: [] });
      byBook.get(it.book).chapters.push(it.chapter);
    }

    const parts = [];
    for (const [bookNum, obj] of Array.from(byBook.entries()).sort((a,b)=>a[0]-b[0])) {
      const ch = obj.chapters.slice().sort((a,b)=>a-b);

      // compress into ranges
      const ranges = [];
      let start = ch[0], prev = ch[0];
      for (let i=1;i<ch.length;i++){
        const cur = ch[i];
        if (cur === prev + 1) {
          prev = cur;
        } else {
          ranges.push([start, prev]);
          start = prev = cur;
        }
      }
      ranges.push([start, prev]);

      const txt = ranges.map(([a,b]) => a === b ? String(a) : `${a}â€“${b}`).join(", ");
      parts.push(`${obj.bookName} ${txt}`);
    }
    return parts.join(" Â· ");
  }

  function matchesQuery(dayObj, q){
    if (!q) return true;
    const qn = normalize(q);
    const ref = normalize(formatRefs(dayObj.items));
    return ref.includes(qn) || normalize(`jour ${dayObj.day}`).includes(qn);
  }

  function openDay(dayObj){
    if (!dayObj?.items?.length) return;
    setLastDay(dayObj.day);
    // open first chapter of the day
    location.href = dayObj.items[0].url;
  }

  function toggleDone(day){
    const done = getDoneSet();
    if (done.has(day)) done.delete(day);
    else done.add(day);
    saveDoneSet(done);
  }

  function isDone(day){
    return getDoneSet().has(day);
  }

  // ---------------- Render ----------------
  function renderPlan(plan, todayDay){
    const list = $("planList");
    const info = $("planInfo");
    if (!list || !info) return;

    const doneSet = getDoneSet();
    const doneCount = doneSet.size;
    const lastDay = getLastDay();

    info.innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <span><b>Aujourdâ€™hui :</b> Jour ${todayDay}</span>
        <span>Â·</span>
        <span><b>Faits :</b> ${doneCount} / 365</span>
        <span>Â·</span>
        <span><b>Dernier :</b> ${lastDay ? "Jour "+lastDay : "â€”"}</span>
      </div>
    `;

    const q = $("qplan")?.value?.trim() || "";

    const rows = plan
      .filter(d => matchesQuery(d, q))
      .map(d => {
        const done = doneSet.has(d.day);
        const isToday = d.day === todayDay;
        const refs = formatRefs(d.items);

        return `
          <div class="hit" style="margin-bottom:12px; ${isToday ? "outline:2px solid rgba(100,160,255,.35); outline-offset:2px; border-radius:14px;" : ""}">
            <div class="ref" style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
              <div>
                <b>Jour ${d.day}</b>
                ${isToday ? `<span class="small" style="margin-left:8px;opacity:.85;">(aujourdâ€™hui)</span>` : ``}
                ${done ? `<span class="small" style="margin-left:8px;">âœ… fait</span>` : ``}
              </div>

              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                <button class="btn ${done ? "" : "btn-secondary"}" type="button" data-done="${d.day}">
                  ${done ? "Annuler âœ…" : "Marquer âœ…"}
                </button>
                <button class="btn primary" type="button" data-open="${d.day}">Ouvrir</button>
              </div>
            </div>

            <div class="txt" style="margin-top:8px;">
              ${escapeHTML(refs)}
              <div class="small" style="opacity:.8;margin-top:6px;">
                ${d.items.length} chapitre(s)
              </div>
            </div>
          </div>
        `;
      });

    list.innerHTML = rows.length ? rows.join("") : `<p>Aucun rÃ©sultat.</p>`;

    // events
    list.querySelectorAll("[data-open]").forEach(btn => {
      btn.addEventListener("click", () => {
        const day = Number(btn.getAttribute("data-open"));
        const obj = plan.find(x => x.day === day);
        openDay(obj);
      });
    });

    list.querySelectorAll("[data-done]").forEach(btn => {
      btn.addEventListener("click", () => {
        const day = Number(btn.getAttribute("data-done"));
        toggleDone(day);
        renderPlan(plan, todayDay);
      });
    });
  }

  // ---------------- Init ----------------
  async function initPlan(){
    applyThemeFromStorage();
    setupThemeToggle();
    $("year").textContent = new Date().getFullYear();

    // âœ… IMPORTANT: caminho ABSOLUTO (funciona em /plan/)
    const DB = await loadJSON("/data/segond_1910.json?v=4");

    const { chapters } = buildCanonicalChapters(DB);
    const plan = splitInto365Days(chapters);

    // today (clamp to 365)
    let today = dayOfYearLocal(new Date());
    if (today > 365) today = 365;

    // Buttons
    $("btnToday").addEventListener("click", () => {
      const obj = plan.find(x => x.day === today);
      openDay(obj);
    });

    $("btnContinue").addEventListener("click", () => {
      const last = getLastDay();
      const day = last || today;
      const obj = plan.find(x => x.day === day);
      openDay(obj);
    });

    $("btnToggleDoneToday").addEventListener("click", () => {
      toggleDone(today);
      renderPlan(plan, today);
    });

    $("btnClear").addEventListener("click", () => {
      $("qplan").value = "";
      renderPlan(plan, today);
    });

    $("qplan").addEventListener("input", () => renderPlan(plan, today));

    renderPlan(plan, today);
  }

  window.addEventListener("DOMContentLoaded", () => {
    initPlan().catch(err => {
      console.error(err);
      document.body.innerHTML = `<pre style="color:red">${escapeHTML(err.message)}</pre>`;
    });
  });
  </script>
</body>
</html>