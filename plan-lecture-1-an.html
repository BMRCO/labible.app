<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan de lecture 1 an ‚Äî LaBible.app | LSG 1910</title>
  <meta name="description" content="Plan de lecture biblique en 1 an ‚Äî Louis Segond 1910 (LSG). Lecture du jour, progression, streak et suivi automatique." />
  <meta name="theme-color" content="#0b1220" />
  <link rel="canonical" href="https://labible.app/plan-lecture-1-an.html" />

  <style>
    :root{--bg:#ffffff;--text:#0b1220;--muted:#5a6b85;--card:#f7f8fb;--border:#e5e9f2;--primary:#2d6cdf}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    body.dark{--bg:#0b1220;--text:#f8fbff;--muted:#9ab0c8;--card:#111b2b;--border:#1f2a3d;--primary:#6ea8ff}

    header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:14px 12px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{font-weight:900;font-size:18px}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn:active{transform:translateY(1px)}
    main{padding:18px 12px}
    h1{margin:12px 0 8px}
    .card{border:1px solid var(--border);background:var(--card);border-radius:16px;padding:14px;margin:14px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .progressbar{height:10px;background:var(--border);border-radius:20px;overflow:hidden;margin-top:8px}
    .progressfill{height:100%;background:var(--primary);width:0%;transition:width .4s ease}
    .kpis{display:flex;gap:14px;flex-wrap:wrap}
    .kpi{min-width:120px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-weight:900;font-size:18px;margin-top:2px}

    .todaylist{margin-top:10px;display:grid;gap:10px}
    .item{border:1px solid var(--border);background:rgba(255,255,255,.0);border-radius:14px;padding:12px}
    body.dark .item{background:rgba(0,0,0,.0)}
    .itemtop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .itemtitle{font-weight:900}
    .itemlink{font-size:12px;color:var(--muted);word-break:break-all;margin-top:6px}

    .divider{height:1px;background:var(--border);margin:12px 0}

    .day{padding:10px 0;border-top:1px solid var(--border);display:flex;gap:10px;align-items:flex-start}
    .day .left{min-width:120px;font-weight:900}
    .day .right{flex:1;line-height:1.55}
    .day a{color:inherit;text-decoration:none;border-bottom:1px dotted transparent}
    .day a:hover{border-bottom-color:var(--muted)}

    footer{border-top:1px solid var(--border);padding:18px 12px;text-align:center;color:var(--muted);background:var(--bg)}
    footer a{text-decoration:none;color:inherit}
    .links{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="brand">LaBible.app <span class="muted">| LSG 1910</span></div>
        <div class="muted" style="font-size:13px">Plan de lecture en 1 an</div>
      </div>
      <button id="toggleTheme" class="btn" type="button" title="Mode sombre">üåô</button>
    </div>
  </div>
</header>

<main class="wrap">
  <h1>üìñ Plan de lecture ‚Äî 365 jours</h1>

  <div class="card">
    <div class="kpis">
      <div class="kpi">
        <div class="label">Jour actuel</div>
        <div class="value" id="kpiDay">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="label">Progression</div>
        <div class="value" id="kpiProgress">0 / 365</div>
      </div>
      <div class="kpi">
        <div class="label">üî• Streak</div>
        <div class="value" id="kpiStreak">0</div>
      </div>
    </div>

    <div class="progressbar">
      <div class="progressfill" id="progressFill"></div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="muted" id="metaLine" style="font-size:13px">‚Äî</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <button id="btnStart" class="btn" type="button">Commencer aujourd‚Äôhui</button>
        <button id="btnReset" class="btn" type="button">R√©initialiser</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div style="font-weight:900;font-size:16px">üìÖ Lecture du jour</div>
        <div class="muted" id="todayStatus" style="font-size:13px;margin-top:4px">‚Äî</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
        <button id="btnShare" class="btn" type="button">üì§ Partager</button>
        <button id="btnOpenAll" class="btn" type="button">üìö Tout ouvrir</button>
        <button id="btnMark" class="btn btn-primary" type="button">‚úÖ Marquer comme lu</button>
      </div>
    </div>

    <div class="todaylist" id="todayList"></div>
  </div>

  <div class="card">
    <div class="row">
      <div style="font-weight:900">Liste des jours</div>
      <div class="muted" style="font-size:13px">Affichage complet (365 jours)</div>
    </div>
    <div id="planList"></div>
  </div>
</main>

<footer>
  <div class="links">
    <a href="/">Accueil</a>
    <a href="/plan-lecture-1-an.html">Plan 1 an</a>
    <a href="/a-propos.html">√Ä propos</a>
    <a href="/confidentialite.html">Confidentialit√©</a>
    <a href="/contact.html">Contact</a>
  </div>
  <div>Texte biblique : Louis Segond 1910 ‚Äî Domaine public.</div>
</footer>

<script>
/* ===================== THEME ===================== */
(function(){
  const apply = () => { if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark"); };
  apply();
  const btn = document.getElementById("toggleTheme");
  const sync = () => { if(btn) btn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô"; };
  sync();
  if(btn){
    btn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
      sync();
    });
  }
})();
</script>

<script>
/* ===================== PLAN (chapitres r√©els) ===================== */
const $ = (id) => document.getElementById(id);

async function loadJSON(path){
  const r = await fetch(path, { cache: "no-store" });
  if(!r.ok) throw new Error("Erreur de chargement : " + path);
  return r.json();
}

function normalize(s){
  return String(s).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}
function slugifyBookName(name){
  return normalize(name)
    .replace(/['‚Äô]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/-+/g,"-")
    .replace(/^-|-$/g,"");
}
function escapeHTML(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function fmtDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function daysBetween(d0,d1){
  const a = Date.UTC(d0.getFullYear(), d0.getMonth(), d0.getDate(), 12,0,0);
  const b = Date.UTC(d1.getFullYear(), d1.getMonth(), d1.getDate(), 12,0,0);
  return Math.floor((b-a)/86400000);
}

/* Storage */
const STORAGE = "labible_plan_dashboard_v5"; // novo
function getState(){
  try { return JSON.parse(localStorage.getItem(STORAGE)) || { startDate:null, doneDays:{} }; }
  catch { return { startDate:null, doneDays:{} }; }
}
function saveState(st){ localStorage.setItem(STORAGE, JSON.stringify(st)); }
function resetState(){ localStorage.removeItem(STORAGE); }
function isDone(dayIndex){ return !!getState().doneDays[String(dayIndex)]; }
function setDone(dayIndex, yes){
  const st = getState();
  if(!st.startDate) return;
  if(yes) st.doneDays[String(dayIndex)] = true;
  else delete st.doneDays[String(dayIndex)];
  saveState(st);
}
function countDone(){ return Object.keys(getState().doneDays||{}).length; }

/* Plan building */
function bookOrderFromDB(DB){
  const mapName = new Map();
  const mapChapters = new Map();
  for(const v of DB.verses){
    if(!mapName.has(v.book)) mapName.set(v.book, v.book_name);
    if(!mapChapters.has(v.book)) mapChapters.set(v.book, new Set());
    mapChapters.get(v.book).add(v.chapter);
  }
  return Array.from(mapName.entries())
    .map(([book,name]) => ({
      book, name,
      slug: slugifyBookName(name),
      chapters: Array.from(mapChapters.get(book)||[]).sort((a,b)=>a-b)
    }))
    .sort((a,b)=>a.book-b.book);
}

function buildChapterRefs(books, min, max){
  const refs = [];
  for(const b of books){
    if(b.book < min || b.book > max) continue;
    for(const c of b.chapters){
      refs.push({ book:b.book, bookName:b.name, bookSlug:b.slug, chapter:c });
    }
  }
  return refs;
}

function buildPsalmsProverbs(books){
  const ps = books.find(b => normalize(b.name).includes("psaume") || b.book===19);
  const pr = books.find(b => normalize(b.name).includes("proverbe") || b.book===20);
  const psRefs = ps ? ps.chapters.map(c => ({ book:ps.book, bookName:ps.name, bookSlug:ps.slug, chapter:c })) : [];
  const prRefs = pr ? pr.chapters.map(c => ({ book:pr.book, bookName:pr.name, bookSlug:pr.slug, chapter:c })) : [];
  const merged = [];
  let i=0,j=0;
  while(i<psRefs.length || j<prRefs.length){
    if(i<psRefs.length) merged.push(psRefs[i++]);
    if(j<prRefs.length) merged.push(prRefs[j++]);
  }
  return merged;
}

function buildPlan365(DB){
  const books = bookOrderFromDB(DB);
  const ot = buildChapterRefs(books, 1, 39);
  const nt = buildChapterRefs(books, 40, 66);
  const pspr = buildPsalmsProverbs(books);

  const plan = [];
  let iOT=0, iNT=0, iPP=0;

  for(let day=0; day<365; day++){
    const items = [];

    if(iOT < ot.length) items.push(ot[iOT++]);
    if(iOT < ot.length) items.push(ot[iOT++]);

    if(iNT < nt.length) items.push(nt[iNT++]);

    if(day % 2 === 0 && iPP < pspr.length) items.push(pspr[iPP++]);

    while(items.length < 3){
      if(iOT < ot.length) items.push(ot[iOT++]);
      else if(iNT < nt.length) items.push(nt[iNT++]);
      else if(iPP < pspr.length) items.push(pspr[iPP++]);
      else break;
    }

    plan.push({ day, items });
  }
  return plan;
}

function linkFor(ref){ return `/${ref.bookSlug}/${ref.chapter}`; }
function labelFor(ref){ return `${ref.bookName} ${ref.chapter}`; }

/* UI */
let PLAN = null;
let TODAY_INDEX = 0;

function computeTodayIndex(){
  const st = getState();
  if(!st.startDate) return 0;
  const start = new Date(st.startDate + "T00:00:00");
  const today = new Date();
  let idx = daysBetween(start, today);
  if(idx < 0) idx = 0;
  if(idx > 364) idx = 364;
  return idx;
}

function computeStreak(){
  const st = getState();
  if(!st.startDate) return 0;
  const idx = computeTodayIndex();
  let s = 0;
  for(let i=idx; i>=0; i--){
    if(isDone(i)) s++;
    else break;
  }
  return s;
}

function updateHeader(){
  const st = getState();

  if(!st.startDate){
    $("kpiDay").textContent = "‚Äî";
    $("kpiProgress").textContent = "0 / 365";
    $("kpiStreak").textContent = "0";
    $("progressFill").style.width = "0%";
    $("metaLine").textContent = "Clique sur ‚ÄúCommencer aujourd‚Äôhui‚Äù pour d√©marrer.";
    return;
  }

  TODAY_INDEX = computeTodayIndex();
  $("kpiDay").textContent = "Jour " + (TODAY_INDEX+1);

  const done = countDone();
  $("kpiProgress").textContent = done + " / 365";
  $("progressFill").style.width = Math.round((done/365)*100) + "%";

  $("kpiStreak").textContent = String(computeStreak());

  const start = new Date(st.startDate + "T00:00:00");
  $("metaLine").textContent = "D√©but : " + fmtDate(start) + " ‚Ä¢ Aujourd‚Äôhui : " + fmtDate(new Date());
}

function renderToday(){
  const st = getState();
  const box = $("todayList");

  if(!st.startDate){
    $("todayStatus").textContent = "‚Äî";
    box.innerHTML = `<div class="muted">D√©marre le plan pour voir la lecture du jour.</div>`;
    $("btnMark").textContent = "‚úÖ Marquer comme lu";
    return;
  }

  TODAY_INDEX = computeTodayIndex();
  const day = PLAN[TODAY_INDEX];
  const done = isDone(TODAY_INDEX);

  $("todayStatus").textContent = done ? "‚úÖ Lu" : "‚¨ú Non lu";
  $("btnMark").textContent = done ? "‚Ü© Annuler" : "‚úÖ Marquer comme lu";

  box.innerHTML = day.items.map(ref => {
    const href = linkFor(ref);
    return `
      <div class="item">
        <div class="itemtop">
          <div class="itemtitle">${escapeHTML(labelFor(ref))}</div>
          <a class="btn" href="${href}" style="text-decoration:none">Lire</a>
        </div>
        <div class="itemlink">${location.origin}${href}</div>
      </div>
    `;
  }).join("");
}

function renderList(){
  const st = getState();
  const el = $("planList");

  if(!st.startDate){
    el.innerHTML = `<div class="muted" style="padding-top:10px">Le plan appara√Ætra apr√®s ‚ÄúCommencer aujourd‚Äôhui‚Äù.</div>`;
    return;
  }

  const html = PLAN.map(d => {
    const done = isDone(d.day);
    const items = d.items.map(ref => `<a href="${linkFor(ref)}">${escapeHTML(labelFor(ref))}</a>`).join(" ‚Ä¢ ");
    return `
      <div class="day">
        <div class="left">${done ? "‚úÖ" : "‚¨ú"} Jour ${d.day+1}</div>
        <div class="right">${items}</div>
      </div>
    `;
  }).join("");

  el.innerHTML = html;
}

/* Share + open all */
async function shareToday(){
  const st = getState();
  if(!st.startDate) return;

  const day = PLAN[computeTodayIndex()];
  const dayNumber = day.day + 1;

  const lines = day.items.map(ref => `- ${labelFor(ref)}: ${location.origin}${linkFor(ref)}`).join("\n");
  const text = `üìñ Plan de lecture (1 an) ‚Äì Jour ${dayNumber}\n\n${lines}\n\nLaBible.app`;

  try{
    if(navigator.share){
      await navigator.share({ title: `Plan de lecture ‚Äì Jour ${dayNumber}`, text });
      return;
    }
  }catch(_){}

  try{
    await navigator.clipboard.writeText(text);
    alert("Lecture du jour copi√©e ‚úÖ");
    return;
  }catch(_){}

  prompt("Copiez le texte :", text);
}

function openAll(){
  const st = getState();
  if(!st.startDate) return;

  const day = PLAN[computeTodayIndex()];
  // abre em abas (no telem√≥vel pode abrir 1 a 1 conforme permiss√µes)
  for(const ref of day.items){
    window.open(linkFor(ref), "_blank");
  }
}

/* Buttons */
function wire(){
  $("btnStart").addEventListener("click", () => {
    const st = getState();
    if(!st.startDate){
      st.startDate = fmtDate(new Date());
      st.doneDays = {};
      saveState(st);
    }
    updateHeader();
    renderToday();
    renderList();
  });

  $("btnReset").addEventListener("click", () => {
    if(!confirm("R√©initialiser le plan (progression supprim√©e) ?")) return;
    resetState();
    updateHeader();
    renderToday();
    renderList();
  });

  $("btnMark").addEventListener("click", () => {
    const st = getState();
    if(!st.startDate) return;
    const idx = computeTodayIndex();
    setDone(idx, !isDone(idx));
    updateHeader();
    renderToday();
    renderList();
  });

  $("btnShare").addEventListener("click", shareToday);
  $("btnOpenAll").addEventListener("click", openAll);
}

/* Init */
window.addEventListener("DOMContentLoaded", async () => {
  try{
    const DB = await loadJSON("/data/segond_1910.json");
    PLAN = buildPlan365(DB);

    wire();
    updateHeader();
    renderToday();
    renderList();
  }catch(err){
    console.error(err);
    document.body.innerHTML = `<pre style="color:red;white-space:pre-wrap">${escapeHTML(err.message)}</pre>`;
  }
});
</script>

</body>
</html>